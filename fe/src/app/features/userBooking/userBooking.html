<div class="w-full h-screen relative overflow-hidden bg-gray-100">
  <!-- Map Component -->
  <app-map [origin]="origin" [destination]="destination" [routeGeometry]="routeGeometry" [activeDriver]="activeDriver"
    [driverRoute]="driverRouteGeometry" (mapReady)="onMapReady()" (tokenInvalid)="onTokenInvalid()"
    (userLocationDetected)="onUserLocationDetected($event)" class="absolute inset-0 z-0">
  </app-map>

  <!-- User Header -->
  <app-user-header [userName]="userName" (avatarClick)="onAvatarClick()" class="absolute top-0 left-0 z-20">
  </app-user-header>
  <!-- API Token Invalid Error -->
  @if (!isTokenValid) {
  <div class="absolute top-20 left-5 right-5 z-20 p-4 bg-red-500 text-white rounded-2xl shadow-lg">
    ❌ API Key invalid!
  </div>
  }

  <!-- Booking Panel (IDLE & PENDING States) -->
  @if (rideState === RideState.IDLE || rideState === RideState.PENDING) {
  <div class="absolute bottom-0 left-0 right-0 z-30 p-4 pt-2">
    <div
      class="bg-gradient-to-b from-white/50 to-white/30 backdrop-blur-md rounded-3xl shadow-2xl drop-shadow-2xl flex flex-col gap-1">

      <!-- Location Search -->
      <app-location-search placeholder="Bạn muốn đi đâu?" [suggestions]="searchSuggestions"
        [showSuggestions]="showSearchSuggestions" (searchChanged)="onSearchChanged($event)"
        (suggestionSelected)="onSuggestionSelected($event)" (searchSubmitted)="onSearchSubmitted($event)"
        class="w-full pt-5">
      </app-location-search>

      <!-- Route Info -->
      @if (routeInfo) {
      <app-route-info [routeInfo]="routeInfo" (clearRoute)="onClearRoute()">
      </app-route-info>
      }

      <!-- Vehicle Selection -->
      @if (routeInfo && isBookingTypesLoaded) {
      <app-vehicle-selection [selectedVehicle]="selectedVehicle" [routeInfo]="routeInfo" [bookingTypes]="bookingTypes"
        [disabled]="isBookingInProgress || !isBookingTypesLoaded" (vehicleSelected)="onVehicleSelected($event)"
        (bookRideClicked)="onBookRide($event)" class="px-6 pb-6">
      </app-vehicle-selection>
      }

      <!-- Loading Indicator for Booking Types -->
      @if (routeInfo && !isBookingTypesLoaded) {
      <div class="px-6 pb-6 text-center text-gray-600">
        <p>Đang tải thông tin giá...</p>
      </div>
      }

    </div>
  </div>
  }

  @if (
  rideState === RideState.CONFIRMED ||
  rideState === RideState.PICKINGUP ||
  rideState === RideState.ONGOING ||
  rideState === RideState.FINISHED
  ) {
  <div
    class="absolute bottom-6 left-4 right-4 md:left-auto md:right-6 z-30 md:w-96 transition-all duration-500 ease-in-out">
    <app-booked-ride-info [driverData]="driverInfo" [rideStatus]="rideState" [driverLocation]="driverLocation"
      [destination]="destination" (cancelRide)="onCancelBooking()">
    </app-booked-ride-info>
  </div>
  }

  <!-- Loading Overlay -->
  <!-- @if (loading) {
  <div class="absolute inset-0 z-40 bg-black/20 backdrop-blur-sm flex items-center justify-center">
    <div class="bg-white rounded-full p-4 shadow-lg">
      <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
        </path>
      </svg>
    </div>
  </div>
  } -->

</div>

<!-- Customer Notification Modal -->
<app-customer-notification-modal [isVisible]="showNotificationModal" [notification]="notificationData"
  (close$)="onCloseNotificationModal()" (retry$)="onRetryBooking()" (cancel$)="onCancelBooking()">
</app-customer-notification-modal>