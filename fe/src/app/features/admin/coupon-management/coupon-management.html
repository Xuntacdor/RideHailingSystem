<div class="p-8 max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Coupon Management</h1>
        <button (click)="openCreateModal()"
            class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-medium hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200">
            <span class="text-xl mr-2">+</span> Create Coupon
        </button>
    </div>

    <div *ngIf="loading" class="text-center py-12 text-gray-500 text-lg">Loading coupons...</div>

    <div *ngIf="!loading && (!coupons || coupons.length === 0)" class="text-center py-12">
        <p class="text-gray-500 text-lg">No coupons found. Create your first coupon to get started!</p>
    </div>

    <div *ngIf="!loading && coupons && coupons.length > 0" class="bg-white rounded-xl shadow-sm overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-50 border-b-2 border-gray-200">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Code
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Discount</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Usage
                        Limits</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Expiration</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <tr *ngFor="let coupon of coupons" class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-mono font-semibold text-gray-900">{{ coupon.code }}</div>
                        <div class="text-sm text-gray-500 mt-1">{{ coupon.content }}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span
                            class="inline-block px-2.5 py-1 rounded-full text-xs font-semibold uppercase tracking-wide"
                            [ngClass]="{
                'bg-blue-100 text-blue-800': coupon.couponType === 'DEFAULT',
                'bg-yellow-100 text-yellow-800': coupon.couponType === 'ACHIEVEMENT',
                'bg-purple-100 text-purple-800': coupon.couponType === 'ADMIN_CREATED',
                'bg-pink-100 text-pink-800': coupon.couponType === 'PROMOTIONAL'
              }">
                            {{ coupon.couponType }}
                        </span>
                        <div *ngIf="coupon.achievementType"
                            class="mt-1 text-xs bg-yellow-50 text-yellow-700 px-2 py-0.5 rounded inline-block">
                            {{ coupon.achievementType }}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-gray-900">{{ getDiscountDisplay(coupon) }}</td>
                    <td class="px-6 py-4">
                        <div *ngIf="coupon.maxUsageLimit" class="text-sm text-gray-700">Max: {{ coupon.maxUsageLimit }}
                        </div>
                        <div *ngIf="coupon.usagePerUser" class="text-sm text-gray-700">Per User: {{ coupon.usagePerUser
                            }}</div>
                        <div *ngIf="!coupon.maxUsageLimit && !coupon.usagePerUser" class="text-sm text-gray-500">
                            Unlimited</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700">{{ formatDate(coupon.expirationDate) }}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold"
                            [ngClass]="coupon.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                            {{ coupon.isActive ? 'Active' : 'Inactive' }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button (click)="openEditModal(coupon)"
                                class="px-3 py-1.5 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors text-sm"
                                title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button (click)="openAssignModal(coupon)"
                                class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors text-sm"
                                title="Assign to User">
                                üë§
                            </button>
                            <button *ngIf="coupon.isActive" (click)="deactivateCoupon(coupon.id)"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm"
                                title="Deactivate">
                                üö´
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Create/Edit Modal -->
    <div *ngIf="showCreateModal" (click)="closeModal()"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in">
        <div (click)="$event.stopPropagation()"
            class="bg-white rounded-2xl w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">{{ editingCouponId ? 'Edit Coupon' : 'Create New
                    Coupon' }}</h2>
                <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl p-2">&times;</button>
            </div>

            <form [formGroup]="couponForm" (ngSubmit)="saveCoupon()" class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="code" class="block text-sm font-medium text-gray-700 mb-2">Coupon Code *</label>
                        <input type="text" id="code" formControlName="code" placeholder="e.g., WELCOME20"
                            class="w-full px-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
                            [class.border-red-500]="couponForm.get('code')?.invalid && couponForm.get('code')?.touched">
                        <small *ngIf="couponForm.get('code')?.hasError('required') && couponForm.get('code')?.touched"
                            class="text-red-500 text-xs mt-1 block">
                            Code is required
                        </small>
                    </div>

                    <div>
                        <label for="couponType" class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                        <select id="couponType" formControlName="couponType"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option *ngFor="let type of couponTypes" [value]="type">{{ type }}</option>
                        </select>
                    </div>
                </div>

                <div *ngIf="couponForm.get('couponType')?.value === 'ACHIEVEMENT'" class="mb-4">
                    <label for="achievementType" class="block text-sm font-medium text-gray-700 mb-2">Achievement Type
                        *</label>
                    <select id="achievementType" formControlName="achievementType"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Select Achievement</option>
                        <option *ngFor="let type of achievementTypes" [value]="type">{{ type }}</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="content" formControlName="content" rows="3"
                        placeholder="e.g., Welcome bonus for new users"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-y"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="discountPercentage" class="block text-sm font-medium text-gray-700 mb-2">Discount
                            Percentage (%)</label>
                        <input type="number" id="discountPercentage" formControlName="discountPercentage" min="0"
                            max="100" placeholder="e.g., 20"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <div>
                        <label for="discountAmount" class="block text-sm font-medium text-gray-700 mb-2">Discount Amount
                            ($)</label>
                        <input type="number" id="discountAmount" formControlName="discountAmount" min="0"
                            placeholder="e.g., 10"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>

                <small *ngIf="couponForm.hasError('noDiscount') && couponForm.touched"
                    class="text-red-500 text-xs block mb-4">
                    Please provide either discount percentage or discount amount
                </small>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="maxUsageLimit" class="block text-sm font-medium text-gray-700 mb-2">Max Total
                            Uses</label>
                        <input type="number" id="maxUsageLimit" formControlName="maxUsageLimit" min="1"
                            placeholder="Leave empty for unlimited"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <div>
                        <label for="usagePerUser" class="block text-sm font-medium text-gray-700 mb-2">Uses Per
                            User</label>
                        <input type="number" id="usagePerUser" formControlName="usagePerUser" min="1"
                            placeholder="Leave empty for unlimited"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>

                <div class="mb-6">
                    <label for="expirationDate" class="block text-sm font-medium text-gray-700 mb-2">Expiration
                        Date</label>
                    <input type="date" id="expirationDate" formControlName="expirationDate"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="button" (click)="closeModal()"
                        class="px-6 py-2.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" [disabled]="couponForm.invalid"
                        class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        {{ editingCouponId ? 'Update' : 'Create' }} Coupon
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Coupon Modal -->
    <div *ngIf="showAssignModal" (click)="closeModal()"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in">
        <div (click)="$event.stopPropagation()"
            class="bg-white rounded-2xl w-11/12 max-w-md shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">Assign Coupon to User</h2>
                <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl p-2">&times;</button>
            </div>

            <div class="p-6">
                <p class="mb-4 text-gray-700">Assign coupon <strong class="font-semibold">{{
                        selectedCouponForAssignment?.code }}</strong> to a user:</p>

                <div class="mb-6">
                    <label for="userSelect" class="block text-sm font-medium text-gray-700 mb-2">Select User</label>
                    <select id="userSelect" [(ngModel)]="selectedUserId"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">-- Select a user --</option>
                        <option *ngFor="let user of users" [value]="user.id">
                            {{ user.name }} ({{ user.email }})
                        </option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end gap-3 p-6 border-t border-gray-200">
                <button type="button" (click)="closeModal()"
                    class="px-6 py-2.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    Cancel
                </button>
                <button type="button" (click)="assignCoupon()" [disabled]="!selectedUserId"
                    class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    Assign Coupon
                </button>
            </div>
        </div>
    </div>
</div>